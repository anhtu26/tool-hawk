# 3.4 Purchase History Tracking

## Purchase Record Structure

The Purchase History Tracking system maintains a comprehensive record of all tool procurement activities, providing valuable data for inventory management, cost analysis, and vendor performance evaluation. Each purchase record captures detailed information about when, where, and how tools were acquired, creating an audit trail that supports both operational and financial decision-making.

The purchase record structure is designed to capture all relevant aspects of a tool purchase transaction, including:

- **Purchase ID**: A unique identifier for the purchase record, automatically generated by the system.

- **Tool ID**: A reference to the specific tool that was purchased, linking the purchase record to the tool's master record.

- **Purchase Date**: The date when the purchase was made, allowing for chronological tracking of procurement activities.

- **Vendor**: The supplier from whom the tool was purchased. This may or may not match the "Approved Vendor" field in the tool record, allowing the system to track purchases from alternative suppliers.

- **Quantity**: The number of units purchased in this transaction.

- **Unit Cost**: The price paid per unit in this specific purchase. This may differ from the current cost stored in the tool record, allowing for tracking of price changes over time.

- **Total Cost**: The total amount paid for this purchase (quantity × unit cost).

- **Lead Time**: The actual time in days between order placement and receipt of the tools. This information helps evaluate vendor performance and refine lead time estimates for future purchases.

- **Purchase Order Number**: An optional reference to the organization's purchase order system, facilitating cross-referencing with financial records.

- **Quote Number**: An optional reference to vendor quotes received before the purchase.

- **Notes**: Additional free-text information about the purchase, such as special conditions, discounts applied, or quality issues.

- **Document Path**: A reference to attached documentation such as purchase orders, quotes, invoices, or packing slips.

- **Created By**: The user who created the purchase record.

- **Creation Date**: The date and time when the purchase record was created in the system.

- **Last Updated**: The date and time when the purchase record was last modified.

This comprehensive data structure ensures that all relevant information about tool purchases is captured and preserved, supporting both operational needs (knowing when and where tools were purchased) and analytical functions (understanding cost trends and vendor performance).

## Document Attachment System

The Document Attachment System is an integral component of the Purchase History Tracking functionality, enabling users to store and manage digital copies of procurement-related documents alongside their corresponding purchase records. This system ensures that all relevant documentation is readily accessible when needed for reference, audit, or compliance purposes.

The document attachment system supports the following key capabilities:

### Document Upload

The system provides a streamlined process for attaching documents to purchase records:

1. When creating or editing a purchase record, users can upload one or more documents through a file selection interface.

2. The system supports common document formats, with a primary focus on PDF files but also accepting other formats such as:
   - PDF documents (quotes, purchase orders, invoices)
   - Image files (JPEG, PNG) for photographed documents or receipts
   - Excel spreadsheets (for detailed pricing or specifications)
   - Word documents (for contracts or terms)

3. The upload interface includes drag-and-drop functionality for ease of use, as well as a traditional file browser option.

4. For each uploaded document, the user can provide an optional description to identify its content or purpose.

5. The system performs basic validation on uploaded files:
   - File size limits (typically 10MB per file)
   - File type verification
   - Virus/malware scanning

### Document Storage

Uploaded documents are stored securely within the system:

1. Files are saved to a dedicated storage location on the server's file system, organized in a structured directory hierarchy.

2. Each file is renamed using a consistent naming convention that includes:
   - A unique identifier
   - The original upload timestamp
   - A reference to the associated purchase record
   - The original file extension

3. The file path is stored in the purchase record, creating a link between the database record and the physical file.

4. The system maintains the original file name as metadata to display to users, regardless of the actual storage file name.

5. Access to stored documents is controlled through the application's authentication and authorization system, ensuring that only authorized users can view or download sensitive procurement documents.

### Document Viewing

The system provides convenient access to attached documents:

1. In the purchase history view, attached documents are represented by appropriate icons or thumbnails based on their file type.

2. Users can click on a document to view it directly within the application using an embedded document viewer.

3. The document viewer supports:
   - PDF rendering with zoom, page navigation, and search capabilities
   - Image display with zoom and pan functions
   - Fallback to download for unsupported file types

4. Users can also download documents to their local system for offline viewing or printing.

5. For multi-page documents, the viewer provides thumbnail navigation to quickly access specific pages.

### Document Management

The system includes basic document management capabilities:

1. Users with appropriate permissions (admin or manager) can:
   - Add new documents to existing purchase records
   - Replace existing documents with updated versions
   - Remove documents that are no longer relevant
   - Rename or update the description of documents

2. The system maintains a version history for documents that are replaced, preserving previous versions for audit purposes.

3. Document operations are logged in the system audit trail, recording who performed each action and when.

4. Bulk operations are supported for efficiency, such as downloading all documents related to a specific purchase or tool.

The document attachment system ensures that all relevant procurement documentation is securely stored and readily accessible, eliminating the need for separate physical filing systems and reducing the risk of lost or misplaced documents.

## Purchase History UI

The Purchase History UI provides a comprehensive interface for viewing, managing, and analyzing tool procurement activities. This interface is accessible both as a standalone section within the application and as a tab within the Tool Detail page, offering flexibility in how users interact with purchase data.

### Purchase History Tab

Within the Tool Detail page, the Purchase History tab presents a chronological record of all purchases for the specific tool:

1. **Table View**: The primary interface is a tabular display of purchase records with columns for:
   - Purchase Date
   - Vendor
   - Quantity
   - Unit Cost
   - Total Cost
   - Lead Time
   - Purchase Order Number
   - Document Indicators (showing whether documents are attached)
   - Actions (edit, delete, view details)

2. **Sorting and Filtering**: Users can sort the table by any column and filter based on criteria such as:
   - Date range
   - Vendor
   - Cost range
   - Purchase order number

3. **Summary Statistics**: Above the table, summary statistics provide quick insights:
   - Total quantity purchased over all time
   - Average unit cost
   - Cost trend indicator (increasing, decreasing, or stable)
   - Average lead time
   - Most frequent vendor

4. **Document Access**: For records with attached documents, the interface provides:
   - Visual indicators showing which records have attachments
   - Thumbnail previews of documents on hover
   - One-click access to view documents in the embedded viewer
   - Download options for offline access

5. **Add Purchase Record**: A prominent button allows users to add new purchase records directly from this view.

### Purchase History Management Page

The standalone Purchase History Management page provides broader capabilities for working with purchase records across all tools:

1. **Advanced Search**: Users can search for purchase records based on multiple criteria:
   - Tool number or name
   - Category
   - Vendor
   - Date range
   - Cost range
   - Purchase order or quote numbers
   - With or without attached documents

2. **Bulk Operations**: The interface supports operations on multiple records:
   - Export selected records to Excel or PDF
   - Print purchase summaries
   - Download all associated documents as a zip archive

3. **Visualization**: The page includes data visualization components:
   - Monthly purchase volume chart
   - Cost trend analysis by tool or category
   - Vendor distribution pie chart
   - Lead time performance by vendor

4. **Vendor Analysis**: A dedicated section provides insights into vendor performance:
   - Comparison of quoted vs. actual lead times
   - Price consistency analysis
   - Volume of purchases by vendor
   - Historical reliability metrics

### Purchase Record Form

The form for adding or editing purchase records is designed for efficiency and accuracy:

1. **Tool Selection**: When accessed from the main Purchase History page (rather than a specific tool's detail page), the form begins with a tool selection step:
   - Typeahead search by tool number or name
   - Recent tools quick selection
   - Category-based browsing

2. **Purchase Details**: The form collects all relevant purchase information:
   - Purchase date (with calendar picker)
   - Vendor (with typeahead from vendor database)
   - Quantity and unit cost (with automatic total calculation)
   - Lead time
   - Purchase order and quote numbers
   - Notes

3. **Document Upload**: The form includes an intuitive document upload section:
   - Drag-and-drop target area
   - File browser button
   - Preview of selected files before upload
   - Progress indicators during upload
   - Description field for each document

4. **Validation**: The form implements comprehensive validation:
   - Required fields are clearly marked
   - Numeric inputs are validated for reasonable ranges
   - Date inputs are checked for logical consistency
   - File uploads are validated for type and size

5. **Inventory Update Option**: The form includes an option to automatically update the tool's current inventory quantity based on the purchase, with appropriate safeguards to prevent duplicate updates.

### Mobile Considerations

While the application is primarily designed for desktop use, the Purchase History UI includes adaptations for mobile access:

1. Responsive table layouts that reformat for smaller screens
2. Touch-friendly controls for document access
3. Simplified forms with appropriate input types for mobile devices
4. Optimized document viewer for mobile screens

The Purchase History UI combines comprehensive data management capabilities with intuitive access to documents and analytical insights, supporting effective procurement management and decision-making.

## Data Entry Requirements

The Purchase History Tracking system implements specific data entry requirements to ensure the accuracy, completeness, and consistency of procurement records. These requirements guide both the user interface design and the validation logic applied during record creation and modification.

### Required vs. Optional Fields

The system clearly distinguishes between required and optional fields to balance data completeness with entry efficiency:

**Required Fields:**
- Tool ID/Reference: The specific tool being purchased (automatically populated when adding from a tool detail page)
- Purchase Date: When the purchase was made
- Vendor: Who supplied the tool
- Quantity: How many units were purchased
- Unit Cost: The price paid per unit

**Optional Fields:**
- Lead Time: The time between order and receipt
- Purchase Order Number: Reference to internal purchasing system
- Quote Number: Reference to vendor quote
- Notes: Additional context or special conditions
- Documents: Attached files related to the purchase

Required fields are clearly marked in the user interface with visual indicators (typically an asterisk) and are validated before form submission. The system prevents the creation of purchase records with missing required data, ensuring that all essential information is captured.

### Data Validation Rules

The system applies the following validation rules to ensure data quality:

1. **Date Validation**:
   - Purchase date cannot be in the future
   - Purchase date cannot be earlier than the tool's creation date in the system
   - Date format is standardized based on locale settings

2. **Numeric Validation**:
   - Quantity must be a positive integer
   - Unit cost must be a positive number with appropriate decimal precision
   - Lead time must be a non-negative integer

3. **Reference Validation**:
   - Tool reference must point to an existing tool in the database
   - Vendor should be selected from the existing vendor database when possible

4. **Document Validation**:
   - File size limits are enforced (typically 10MB per file)
   - Allowed file types are restricted to supported formats
   - Virus/malware scanning is performed on all uploads

5. **Logical Validation**:
   - Total cost is automatically calculated and verified against quantity × unit cost
   - When inventory updates are requested, the new inventory level is checked against maximum quantity limits

### Data Entry Assistance

The system provides several features to assist users in entering accurate data efficiently:

1. **Auto-completion**:
   - Vendor field offers typeahead suggestions based on previously entered vendors
   - Tool selection (when not pre-selected) offers search by number, name, or category

2. **Default Values**:
   - Purchase date defaults to the current date
   - Vendor defaults to the approved vendor from the tool record when available
   - Unit cost defaults to the last purchase price or the current cost in the tool record

3. **Calculated Fields**:
   - Total cost is automatically calculated based on quantity and unit cost
   - Inventory projections show the expected new inventory level if the purchase is added to current stock

4. **Contextual Help**:
   - Field-level help tooltips explain the purpose and expected format of each input
   - Validation messages provide clear guidance when entered data doesn't meet requirements

5. **Bulk Entry Support**:
   - For efficiency when entering multiple purchase records, the system offers a "Save and Add Another" option that retains common fields (vendor, date, PO number) while clearing tool-specific fields

### Inventory Integration

The purchase history system integrates with the inventory management functionality:

1. When a new purchase record is created, the user has the option to automatically update the tool's current quantity.

2. If this option is selected, the system:
   - Adds the purchased quantity to the current inventory level
   - Verifies that the new total doesn't exceed the maximum quantity setting
   - Creates an audit trail entry documenting the inventory increase
   - Updates the "last restocked" date for the tool

3. If the tool was previously below its safe quantity threshold (triggering low inventory alerts), the system checks whether the new quantity exceeds the threshold and clears any active alerts if appropriate.

4. The inventory update is transactionally linked to the purchase record creation, ensuring data consistency.

These data entry requirements ensure that the Purchase History Tracking system captures accurate, consistent information about tool procurement activities, supporting both operational needs and analytical functions while minimizing the burden on users.
